<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ARCHIVO VENCIMIENTO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="bg-light">

<div class="container mt-4">
    <h1 class="text-center mb-4 text-primary text-uppercase fw-bold">ARCHIVO VENCIMIENTO</h1>

    <div class="card p-4 mb-4 shadow-lg border-0">
        <h4 class="mb-3 text-success">‚ûï Agregar producto</h4>
        <div class="row g-3">
            <div class="col-12 col-md-4">
                <label class="form-label">C√≥digo</label>
                <input type="text" id="codigo" inputmode="numeric" pattern="[0-9]*"
                       class="form-control form-control-sm" placeholder="C√≥digo del producto">
            </div>
            <div class="col-12 col-md-4">
                <label class="form-label">Nombre del art√≠culo</label>
                <input type="text" id="nombre" list="articulos" class="form-control form-control-sm" placeholder="Seleccione o escribe para filtrar">
                <datalist id="articulos">
                    <!-- opciones din√°micas -->
                </datalist>
            </div>
            <div class="col-12 col-md-4">
                <label class="form-label">Fecha de vencimiento</label>
                <input type="date" id="fecha" class="form-control form-control-sm">
            </div>
        </div>
        <button class="btn btn-success btn-sm mt-3 w-100" onclick="agregarProducto()">Agregar producto</button>
    </div>

    <div class="card p-4 shadow-lg border-0">
        <h4 class="mb-3 text-warning">üìã Lista de productos</h4>
        <ul id="lista" class="list-group"></ul>
        <button class="btn btn-warning btn-sm mt-3 w-100" onclick="guardarLista()">Guardar y descargar Excel</button>
    </div>

    <div id="mensaje" class="alert d-none mt-3"></div>
</div>

<script>
function mostrarMensaje(texto, tipo="info") {
    const msg = document.getElementById("mensaje");
    msg.className = `alert alert-${tipo}`;
    msg.textContent = texto;
    msg.classList.remove("d-none");
}

// Cargar todos los nombres desde /nombres (fallback)
async function cargarNombres() {
    try {
        const response = await fetch("/nombres");
        if (!response.ok) return;
        const result = await response.json();
        const datalist = document.getElementById("articulos");
        datalist.innerHTML = '';
        (result.nombres || result).forEach(nombre => {
            let option = document.createElement("option");
            option.value = nombre;
            datalist.appendChild(option);
        });
    } catch (e) {
        // ignore, fallback will handle
    }
}

async function cargarArticulos() {
    const respuesta = await fetch("/api/articulos");
    const articulos = await respuesta.json();

    const datalist = document.getElementById("articulos");
    datalist.innerHTML = ""; // limpiar antes de llenar

    articulos.forEach(a => {
        const option = document.createElement("option");
        option.value = a;
        datalist.appendChild(option);
    });
}

// Llamar al inicio
cargarArticulos();

// Cargar lista actual si existe
async function cargarListaInicial() {
    try {
        const resp = await fetch('/lista');
        if (!resp.ok) return;
        const data = await resp.json();
        if (data.lista) renderLista(data.lista);
    } catch (e) {}
}
cargarListaInicial();

// Permitir Enter en c√≥digo para saltar a fecha
document.getElementById("codigo").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        e.preventDefault();
        const cod = this.value.trim();
        const nom = document.getElementById("nombre").value.trim();
        if (cod && nom) {
            mostrarMensaje("Ingresa SOLO c√≥digo O nombre, no ambos", "warning");
            return;
        }
        if (!cod && !nom) {
            mostrarMensaje("Ingresa c√≥digo o nombre", "warning");
            return;
        }
        document.getElementById("fecha").focus();
    }
});

// Permitir Enter en nombre para saltar a fecha
document.getElementById("nombre").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        e.preventDefault();
        const cod = document.getElementById("codigo").value.trim();
        const nom = this.value.trim();
        if (cod && nom) {
            mostrarMensaje("Ingresa SOLO c√≥digo O nombre, no ambos", "warning");
            return;
        }
        if (!cod && !nom) {
            mostrarMensaje("Ingresa c√≥digo o nombre", "warning");
            return;
        }
        document.getElementById("fecha").focus();
    }
});
</script>

<!-- Input alternativo y lista de ejemplo -->
<div class="container mt-2">
    <div class="mb-3">
        <input type="text" id="articulo" list="articulos" class="form-control form-control-sm">
    </div>
</div>

<!-- Tabla din√°mica de productos -->
<div class="container mt-3">
    <table id="tablaProductos" class="table table-sm"></table>
</div>

<script>
// Datos simulados para la tabla
let productosTabla = [];

function renderArticulosTabla() {
    const datalist = document.getElementById("articulos");
    if (!datalist) return;
    datalist.innerHTML = "";
    productosTabla.forEach(p => {
        const option = document.createElement("option");
        option.value = p;
        datalist.appendChild(option);
    });
}

function renderTablaProductos() {
    const tabla = document.getElementById("tablaProductos");
    if (!tabla) return;
    tabla.innerHTML = "";
    productosTabla.forEach((p, i) => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
            <td>${p}</td>
            <td><button class="btn btn-sm btn-danger" onclick="borrarProductoTabla(${i})">Borrar</button></td>
        `;
        tabla.appendChild(fila);
    });
}

function borrarProductoTabla(index) {
    productosTabla.splice(index, 1); // borra del array
    renderTablaProductos();          // refresca tabla
    renderArticulosTabla();          // refresca desplegable
}

// Render inicial
renderTablaProductos();
renderArticulosTabla();
</script>

</body>
</html>
