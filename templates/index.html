<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="/static/favicon.png">    
    <title>ARCHIVO VENCIMIENTO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/png" href="/static/favicon.png">
</head>
<body class="bg-light">

<div class="container mt-4">
    <h1 class="text-center mb-4 text-primary text-uppercase fw-bold">ARCHIVO VENCIMIENTO</h1>
<div class="row g-3">
    <!-- âœ… DescripciÃ³n primero -->
    <div class="col-12 col-md-4">
        <label class="form-label">Nombre del artÃ­culo</label>
        <input type="text" id="nombre" list="articulos" 
               class="form-control form-control-sm" 
               placeholder="Seleccione o escribe para filtrar">
        <datalist id="articulos"></datalist>
    </div>

    <!-- âœ… CÃ³digo segundo, solo nÃºmeros sin flechas -->
    <div class="col-12 col-md-4">
        <label class="form-label">CÃ³digo</label>
        <input type="text" id="codigo" 
               class="form-control form-control-sm" 
               placeholder="CÃ³digo del producto"
               inputmode="numeric" pattern="[0-9]*"
               oninput="this.value=this.value.replace(/[^0-9]/g,'')">
    </div>

 <!-- Fecha de vencimiento -->
<div class="col-12">
    <label class="form-label">Fecha de vencimiento</label>
    <input type="date" id="fecha" class="form-control form-control-lg"
           onchange="agregarProducto()">
</div>
</div>

<!-- BotÃ³n verde de agregar -->
<button class="btn btn-success btn-sm mt-3 w-100" onclick="agregarProducto()">Agregar producto</button>

<!-- BotÃ³n amarillo de guardar Excel debajo -->
<button class="btn btn-warning btn-sm mt-3 w-100" onclick="guardarLista()">Guardar y descargar Excel</button>

<!-- Tarjeta de lista de productos -->
<div class="card p-4 shadow-lg border-0">
    <h4 class="mb-3 text-warning d-flex justify-content-between align-items-center">
        ðŸ“‹ Lista de productos
        <!-- BotÃ³n para mostrar/ocultar -->
        <button class="btn btn-sm btn-outline-warning" 
                type="button" 
                data-bs-toggle="collapse" 
                data-bs-target="#listaCollapse" 
                aria-expanded="true" 
                aria-controls="listaCollapse">
            Mostrar / Ocultar
        </button>
    </h4>

    <!-- Lista colapsable -->
    <div class="collapse show" id="listaCollapse">
        <ul id="lista" class="list-group"></ul>
    </div>
</div>

    <!-- Lista colapsable -->
    <div class="collapse show" id="listaCollapse">
        <ul id="lista" class="list-group"></ul>
    </div>
</div>  
 
</div>

<script>
function mostrarMensaje(texto, tipo="info") {
    const msg = document.getElementById("mensaje");
    msg.className = `alert alert-${tipo}`;
    msg.textContent = texto;
    msg.classList.remove("d-none");
}

// Cargar todos los nombres desde /nombres (fallback)
async function cargarNombres() {
    try {
        const response = await fetch("/nombres");
        if (!response.ok) return;
        const result = await response.json();
        const datalist = document.getElementById("articulos");
        datalist.innerHTML = '';
        (result.nombres || result).forEach(nombre => {
            let option = document.createElement("option");
            option.value = nombre;
            datalist.appendChild(option);
        });
    } catch (e) {
        // ignore, fallback will handle
    }
}

async function cargarArticulos() {
    const respuesta = await fetch("/api/articulos");
    const articulos = await respuesta.json();

    const datalist = document.getElementById("articulos");
    datalist.innerHTML = ""; // limpiar antes de llenar

    articulos.forEach(a => {
        const option = document.createElement("option");
        option.value = a;
        datalist.appendChild(option);
    });
}

// Llamar al inicio
cargarArticulos();
// Cargar lista actual si existe
async function cargarListaInicial() {
    try {
        const resp = await fetch('/lista');
        if (!resp.ok) return;
        const data = await resp.json();
        if (data.lista) renderLista(data.lista);
    } catch (e) {}
}
cargarListaInicial();

// Permitir Enter en cÃ³digo para saltar a fecha
document.getElementById("codigo").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        e.preventDefault();
        const cod = this.value.trim();
        const nom = document.getElementById("nombre").value.trim();
        if (cod && nom) {
            mostrarMensaje("Ingresa SOLO cÃ³digo O nombre, no ambos", "warning");
            return;
        }
        if (!cod && !nom) {
            mostrarMensaje("Ingresa cÃ³digo o nombre", "warning");
            return;
        }
        document.getElementById("fecha").focus();
    }
});

// Permitir Enter en nombre para saltar a fecha
document.getElementById("nombre").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        e.preventDefault();
        const cod = document.getElementById("codigo").value.trim();
        const nom = this.value.trim();
        if (cod && nom) {
            mostrarMensaje("Ingresa SOLO cÃ³digo O nombre, no ambos", "warning");
            return;
        }
        if (!cod && !nom) {
            mostrarMensaje("Ingresa cÃ³digo o nombre", "warning");
            return;
        }
        document.getElementById("fecha").focus();
    }
});

// Permitir Enter en fecha para agregar producto
document.getElementById("fecha").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        e.preventDefault();
        agregarProducto();
    }
});

async function agregarProducto() {
    const data = {
        codigo: document.getElementById("codigo").value,
        descripcion: document.getElementById("nombre").value,
        fecha_vencimiento: document.getElementById("fecha").value
    };
    if (data.codigo && data.descripcion) {
        mostrarMensaje("Ingresa SOLO cÃ³digo O nombre, no ambos", "warning");
        return;
    }
    if (!data.codigo && !data.descripcion) {
        mostrarMensaje("Ingresa cÃ³digo o nombre", "warning");
        return;
    }
    if (!data.fecha_vencimiento) {
        mostrarMensaje("Ingresa fecha de vencimiento", "warning");
        return;
    }
    const response = await fetch("/agregar_producto", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    });
    const result = await response.json();
    if (result.lista) {
        renderLista(result.lista);
        mostrarMensaje("âœ… Producto agregado correctamente", "success");
        document.getElementById("codigo").value = "";
        document.getElementById("nombre").value = "";
        document.getElementById("fecha").value = "";
        document.getElementById("codigo").focus();
    } else {
        mostrarMensaje(result.detail || "Error al agregar producto", "danger");
    }
}

async function guardarLista() {
    // Validar que la lista en pantalla tenga elementos
    const cont = document.getElementById('lista');
    if (!cont || cont.children.length === 0) {
        mostrarMensaje('La lista estÃ¡ vacÃ­a. Agrega productos antes de guardar.', 'warning');
        return;
    }

    try {
        const response = await fetch("/guardar_lista", { method: "POST" });
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "lista_final.xlsx";
            a.click();
            mostrarMensaje("ðŸ“‚ Lista guardada y descargada", "success");
            return;
        }

        // Intentar leer mensaje de error del servidor
        let detail = '';
        try {
            const json = await response.json();
            detail = json.detail || json.mensaje || JSON.stringify(json);
        } catch (e) {
            detail = await response.text();
        }
        mostrarMensaje(`Error al guardar la lista (${response.status}): ${detail}`, 'danger');
    } catch (e) {
        mostrarMensaje('Error de conexiÃ³n al guardar la lista', 'danger');
    }
}

async function borrarProducto(codigo) {
    try {
        const response = await fetch(`/borrar_producto/${encodeURIComponent(codigo)}`, { method: "DELETE" });
        if (!response.ok) {
            let err = {};
            try { err = await response.json(); } catch(e) {}
            mostrarMensaje(err.detail || err.mensaje || "Error al eliminar producto", "danger");
            return;
        }
        const result = await response.json();
        renderLista(result.lista || []);
        mostrarMensaje(result.mensaje || "ðŸ—‘ï¸ Producto eliminado", "warning");
    } catch (e) {
        mostrarMensaje("Error al eliminar producto", "danger");
    }
}

// Nota: eliminar funciÃ³n de borrado por nombre para evitar conflictos

function renderLista(lista) {
    const contenedor = document.getElementById("lista");
    contenedor.innerHTML = "";
    if (!Array.isArray(lista)) return;
        lista.forEach(p => {
            let li = document.createElement("li");
            li.className = "list-group-item small d-flex justify-content-between align-items-center";
            li.dataset.codigo = String(p.Codigo || '');
            li.innerHTML = `
                <div>
                    <strong>CÃ³digo:</strong> ${p.Codigo} | <strong>Fecha:</strong> <span class="fecha">${p.FechaVencimiento}</span><br>
                    <strong>DescripciÃ³n:</strong> ${p.Descripcion}<br>
                    <strong>Estado:</strong> ${p.Estado}
                </div>
                <div>
                    <button class="btn btn-secondary btn-sm me-2 btn-modificar" onclick="startEdit('${p.Codigo}')">Modificar</button>
                    <button class="btn btn-success btn-sm me-2 btn-guardar d-none" onclick="saveEdit('${p.Codigo}')">Guardar</button>
                    <button class="btn btn-outline-secondary btn-sm me-2 btn-cancel d-none" onclick="cancelEdit('${p.Codigo}')">Cancelar</button>
                    <button class="btn btn-danger btn-sm btn-borrar" onclick="borrarProducto('${p.Codigo}')">Borrar</button>
                </div>
            `;
            contenedor.appendChild(li);
        });
}

// (La ediciÃ³n ahora usa startEdit/saveEdit/cancelEdit)

// Iniciar ediciÃ³n en lÃ­nea de la fecha: mostrar input[type=date]
function startEdit(codigo) {
    const li = document.querySelector(`li[data-codigo="${codigo}"]`);
    if (!li) return;
    const spanFecha = li.querySelector('.fecha');
    const current = spanFecha ? spanFecha.textContent.trim() : '';
    // Crear input date
    const input = document.createElement('input');
    input.type = 'date';
    input.className = 'form-control form-control-sm d-inline-block';
    input.style.width = 'auto';
    // Si current tiene formato YYYY-MM-DD, usarlo
    input.value = current || '';
    spanFecha.replaceWith(input);
    // Mostrar botones guardar/cancelar
    li.querySelectorAll('.btn-modificar').forEach(b=>b.classList.add('d-none'));
    li.querySelectorAll('.btn-borrar').forEach(b=>b.classList.add('d-none'));
    li.querySelectorAll('.btn-guardar').forEach(b=>b.classList.remove('d-none'));
    li.querySelectorAll('.btn-cancel').forEach(b=>b.classList.remove('d-none'));
}

// Cancelar ediciÃ³n: restaurar span.fecha con el valor original (pedir al backend lista actual)
function cancelEdit(codigo) {
    cargarListaInicial(); // recargar la lista para restaurar el contenido original
}

// Guardar ediciÃ³n: enviar nueva fecha y refrescar lista
async function saveEdit(codigo) {
    const li = document.querySelector(`li[data-codigo="${codigo}"]`);
    if (!li) return;
    const input = li.querySelector('input[type="date"]');
    if (!input) return;
    const nuevaFecha = input.value;
    if (!nuevaFecha) return mostrarMensaje('Ingrese una fecha vÃ¡lida', 'warning');
    try {
        const url = `/modificar_producto/${encodeURIComponent(codigo)}?nueva_fecha=${encodeURIComponent(nuevaFecha)}`;
        const resp = await fetch(url, { method: 'PUT' });
        if (!resp.ok) {
            let err = {};
            try { err = await resp.json(); } catch(e) {}
            mostrarMensaje(err.detail || err.mensaje || 'Error al modificar producto', 'danger');
            return;
        }
        const data = await resp.json();
        // Intentar actualizar sÃ³lo la fila en el DOM usando la lista devuelta
        const updated = (data.lista || []).find(item => String(item.Codigo) === String(codigo));
        if (updated) {
            // actualizar contenido de la columna izquierda
            const leftDiv = li.querySelector('div');
            if (leftDiv) {
                leftDiv.innerHTML = `
                                <strong>CÃ³digo:</strong> ${updated.Codigo} | <strong>Fecha:</strong> <span class="fecha">${updated.FechaVencimiento}</span><br>
                                <strong>DescripciÃ³n:</strong> ${updated.Descripcion}<br>
                                <strong>Estado:</strong> ${updated.Estado}
                        `;
            }
            // alternar botones: ocultar guardar/cancelar y mostrar modificar/borrar
            li.querySelectorAll('.btn-guardar').forEach(b=>b.classList.add('d-none'));
            li.querySelectorAll('.btn-cancel').forEach(b=>b.classList.add('d-none'));
            li.querySelectorAll('.btn-modificar').forEach(b=>b.classList.remove('d-none'));
            li.querySelectorAll('.btn-borrar').forEach(b=>b.classList.remove('d-none'));
            mostrarMensaje(data.mensaje || 'Producto modificado', 'success');
        } else {
            // fallback: recargar lista completa
            renderLista(data.lista || []);
            mostrarMensaje(data.mensaje || 'Producto modificado', 'success');
        }
    } catch (e) {
        mostrarMensaje('Error al modificar producto', 'danger');
    }
}
</script>

<!-- Input alternativo y lista de ejemplo (usa el mismo datalist `articulos`) -->
<div class="container mt-2">
    <div class="mb-3">
        <input type="text" id="articulo" list="articulos" class="form-control form-control-sm">
    </div>

    <!-- lista de ejemplo eliminada (sin valores predeterminados) -->
</div>

<!-- Sin funciÃ³n local de borrado ni valores predeterminados -->

</body>
</html>

<!-- Tabla dinÃ¡mica de productos y sincronizaciÃ³n con datalist -->
<div class="container mt-3">
  
    <table id="tablaProductos" class="table table-sm"></table>
</div>

<script>
// Datos simulados para la tabla
let productosTabla = [];

function renderArticulosTabla() {
    const datalist = document.getElementById("articulos");
    if (!datalist) return;
    datalist.innerHTML = "";
    productosTabla.forEach(p => {
        const option = document.createElement("option");
        option.value = p;
        datalist.appendChild(option);
    });
}

function renderTablaProductos() {
    const tabla = document.getElementById("tablaProductos");
    if (!tabla) return;
    tabla.innerHTML = "";
    productosTabla.forEach((p, i) => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
            <td>${p}</td>
            <td><button class="btn btn-sm btn-danger" onclick="borrarProductoTabla(${i})">Borrar</button></td>
        `;
        tabla.appendChild(fila);
    });
}

function borrarProductoTabla(index) {
    productosTabla.splice(index, 1); // borra del array
    renderTablaProductos();              // refresca tabla
    renderArticulosTabla();          // refresca desplegable
}

// Render inicial
renderTablaProductos();
renderArticulosTabla();
</script>









